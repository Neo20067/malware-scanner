<?php 
/*
.---------------------------------------------------------------------------.
|  Software: Websites Malware Scanner  		                            |
|   Version: 0.1 Beta                                                       |
|      Site: http://www.reventions.com					    |
| ------------------------------------------------------------------------- |
|   Author : Mahmoud Elgohary (_v_mahmoud) vmahmoud24@gmail.com		    |
|   				http://github.com/VMahmoud		    |
| Copyright (c) 2013, Reventions. All Rights Reserved.         		    |
| Software was proudly made in Egypt			         	    |
| ------------------------------------------------------------------------- |
|   License: Distributed under the Lesser General Public License (LGPL)     |
|            http://www.gnu.org/copyleft/lesser.html                        |
| This program is distributed in the hope that it will be useful - WITHOUT  |
| ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or     |
| FITNESS FOR A PARTICULAR PURPOSE.                                         |
'---------------------------------------------------------------------------'
*/
if(isset($_POST['upload_pattern'])){
	session_start();
	// Extracting pattern
	$file = file_get_contents($_FILES["pattern"]["tmp_name"]);
	$pattern = explode("<--V-->",$file);
	$_SESSION['pattern'] = array();
	foreach($pattern as $p){
	$_SESSION['pattern'][] = $p;
	}
	}
if(isset($_POST['file']) && !isset($_POST['upload_pattern'])){ 
session_start();
$pattern = $_SESSION['pattern'];
// Getting posted file via AJAX
$file = trim($_POST['file'].PHP_EOL);
// Exclude this script and its pattern from replacement
$thisFile = basename(__FILE__);
if(strpos($file,$thisFile)){
	die();
}
// If file exists, go through it
if(file_exists($file)){
$content = file_get_contents($file);
$clearContent = str_replace($pattern,"",$content,$count);
// Replace the old content with the clear one
file_put_contents($file,$clearContent);
// If the pattern existed, the replace it and print a message for status report
if($count){
	echo "Malware detected: ".$file." - pattern was found ".$count." time[s] \n ------------- \n";
}
}
?>
<?php } ?>
<?php if(!isset($_POST['file']) && isset($_POST['upload_pattern'])){  
// Starting time of the script, for execution time calculation
$start = microtime(true);

// Setting scripting time to zero, for infinity direcotry discovery
set_time_limit(0);
ini_set('max_execution_time',0);

// Setting file discovery filters
abstract class FilesystemRegexFilter extends RecursiveRegexIterator {
    protected $regex;
    public function __construct(RecursiveIterator $it, $regex) {
        $this->regex = $regex;
        parent::__construct($it, $regex);
    }
}

class FilenameFilter extends FilesystemRegexFilter {
    // Filter files against the regex
    public function accept() {
        return ( ! $this->isFile() || preg_match($this->regex, $this->getFilename()));
    }
}

class DirnameFilter extends FilesystemRegexFilter {
    // Filter directories against the regex
    public function accept() {
        return ( ! $this->isDir() || preg_match($this->regex, $this->getFilename()));
    }
}

$directory = new RecursiveDirectoryIterator(__DIR__);
// Filter out ".Trash*" folders
$filter = new DirnameFilter($directory, '/^(?!\.Trash)/');
// Filter PHP/HTML/JS/CSS files 
$filter = new FilenameFilter($filter, '/\.(?:php|html|js|css)$/');
$files = array();

// Go through all targeted files with specific extension and applied filters
foreach(new RecursiveIteratorIterator($filter) as $file) {
    if(!is_dir($file)){
    $files[] = $file . PHP_EOL;
	}
}
// Calculate execution time for the files discovery process
$time_taken = microtime(true) - $start; 
?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--
.---------------------------------------------------------------------------.
|  Software: Websites Malware Scanner  		                            |
|   Version: 0.1 Beta                                                       |
|      Site: http://www.reventions.com					    |
| ------------------------------------------------------------------------- |
|   Author : Mahmoud Elgohary (_v_mahmoud) vmahmoud24@gmail.com		    |
|   				http://github.com/VMahmoud		    |
| Copyright (c) 2013, Reventions. All Rights Reserved.         		    |
| Software was proudly made in Egypt			         	    |
| ------------------------------------------------------------------------- |
|   License: Distributed under the Lesser General Public License (LGPL)     |
|            http://www.gnu.org/copyleft/lesser.html                        |
| This program is distributed in the hope that it will be useful - WITHOUT  |
| ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or     |
| FITNESS FOR A PARTICULAR PURPOSE.                                         |
'---------------------------------------------------------------------------'
-->
<head>
	<title>Reventions Malware Scanner</title>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
	<style type="text/css">
	*{
		margin:0;
		padding:0;
		}
	*:focus{
		outline:0;
		}
	body{
		background:rgb(221, 221, 221);
		color:#1B1B1B;
		margin-left:auto;
		margin-right:auto;
		font-family:Verdana;
		text-align:center;
		}
	#leftContent{
		float:left;
		padding: 6px;
		}
	#rightContent{
		float:right;
		padding: 25px 10px;
		}
	#rightContent h1{
		font-size:1.7em;
		font-family:Georgia;
		}
	#clear{
		clear:both;
		}
	#result textarea{
		width:60%;
		height:300px;
		border:0;
		padding:10px;
		font-family:Verdana;
		font-size:17px;
		color:#8A8A8A;
		margin-top:10px;
		}
	#process h3{
		color:#5A6D52;
		font-family:Georgia;
		font-size:19px;
		}
	.stopProcess{
		text-decoration: none;
		background: red;
		padding: 5px;
		color: white;
		}
	.stopProcess:hover{
		background: #EF0C39;
		}
	.startProcess{
		text-decoration: none;
		background: #3DA61A;
		padding: 5px;
		color: white;
		}
	.startProcess:hover{
		background: #46BF1E;
		}
	#footer{
		margin-top: 16px;
		}
	#footer h4{
		font-family: sans-serif;
		font-size: 13px;
		color: rgb(92, 65, 65);
		}
	#footer h4 a{
		color:rgb(165, 47, 47);
		}
	#footer h4 a:hover{
		background:#D91125;
		color:#DADADA;
		text-decoration:none;
		}
	</style>
	<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script type="text/javascript">
	$(document).ready(function(){
		// Setting all folders to javascript array, to handle it file by file
		var files = <?php echo json_encode($files); ?>
		// This variable is set to track the whole process
		var stop = 1;
		// Related to execution time estimation in javascript
		var start_time = 0;
		var end_time = 0;
		//Disabling the stop button by default
		$('.stopProcess').removeAttr("href");
		$('.stopProcess').css("background","#606060");
		// OnClick, Start the process
		$('.startProcess').click(function(){
			start_time = new Date().getTime();
			// Enabling the stop button
			$('.stopProcess').attr("href","javascript:;");
			$('.stopProcess').css("background","red");
			// Setting stop process to zero
			stop = 0;
			});
		// Stop and Resume the process
		$('.stopProcess').click(function(){
			if(!stop){
				stop = 1;
				$('.stopProcess').text("Resume");
				}
			else{
				stop=0;
				$('.stopProcess').text("Stop");
				}
			});
		// The main function, to handle file by file, and recalling it self again
		function scanFile(){
			 // If counter is not set, the set it
			 if( typeof scanFile.counter == 'undefined' ) {
					scanFile.counter = 0;
				}
			// While the counter is less than the length of the files array, do the process
			if(scanFile.counter <= files.length){
			// Setting the current file in-process
			$('.currentFile').html(files[scanFile.counter]);
			// While stop trigger is not activated, scan files
			// Note: Stop is activated by default
			if(!stop){
			// Time duration for every file to be scanned is 6 mins.
			setTimeout(function(){		
				// AJAX call to clean the current file
				$.ajax({
				  type: 'POST',
				  timeout: 6000,
				  data: 'file='+files[scanFile.counter],
				  success: function(data) {
					  // Append result to status report
					  $('.statusReport').append(data);
					  // Keep the status report scrolled down
					  $('.statusReport').scrollTop(99999);
				 },
				  error: function(e) {
					//called when there is an error
					console.log(e.message);
				  }
				});
				// Increment the files counter
				scanFile.counter++;
				// Do the process again
				scanFile();
				},6000);
				}
			// While stop is triggered, wait 1 sec, do the process again
			else{
				setTimeout(function(){
				scanFile();
				},1000);
				}
			}
			// While there's no files to be processed, all files have been scanned
			else{
				// Tracking the status report result
				var report = $('.statusReport').text();
				// Stripping out the process indicator as the process is finished, print done instead
				$('#progress').fadeOut("slow");
				$('#progress').html('<b style="color:#559146;">Done!</b>');
				$('#progress').fadeIn("slow");
				// Relative to execution time calculation
				end_time = new Date().getTime();
				var total_time = (end_time - start_time)/(1000*60);
				// If the status report was clear, then no malware detected
				if(report == ""){
				$('.statusReport').append('\nDone! No Malware Detected');
					}
				// If there were malware detected
				else{
				$('.statusReport').append('\nScan Completed');	
					}
				// Stats of the whole process, files scanned and elpased time
				$('.statusReport').append('\nFiles Scanned ['+files.length+']\nScan took ['+Math.round(total_time).toFixed(2)+'] minutes to complete');
				}
			}
		// Initiate the scanFile function
		scanFile();
		});
	</script>
</head>

<body>
<div id="main">
<div id="leftContent">
<a href="http://reventions.com"><img border="0" src="http://www.reventions.com/images/logo.png" /></a>
</div>
<div id="rightContent">
<h1>Malware Scanner</h1>
</div>
</div>
<div id="clear"></div>
<div id="progress">
<div id="process">
<h3>Currently Scanning:</h3>
<h5 class="currentFile">File1</h5>
</div><br />
<a href="javascript:;" class="startProcess">Start</a>
<a href="javascript:;" class="stopProcess">Stop</a>
</div>
<br /><br />
<div id="result">
<label>Status Report</label><br />
<textarea readonly class="statusReport"></textarea>
</div>
<div id="footer">
<h4>Application made in Egypt by: <a title="visit my page on about.me" href="http://about.me/vmahmoud" target="_blank">Mahmoud Elgohary</a></h4>
</div>
<?php
// Printing the time elpased in files discovery
printf ("<br><div align='center'><b>This page took %f seconds to load.", $time_taken."</b></div>");
?>	
</body>

</html>
<?php } ?>
<?php if(!isset($_POST['upload_pattern']) && !isset($_POST['file'])){ ?>
<?php
session_start();
unset($_SESSION['pattern']);
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--
.---------------------------------------------------------------------------.
|  Software: Websites Malware Scanner  		                            |
|   Version: 0.1 Beta                                                       |
|      Site: http://www.reventions.com					    |
| ------------------------------------------------------------------------- |
|   Author : Mahmoud Elgohary (_v_mahmoud) vmahmoud24@gmail.com		    |
|   				http://github.com/VMahmoud		    |
| Copyright (c) 2013, Reventions. All Rights Reserved.         		    |
| Software was proudly made in Egypt			         	    |
| ------------------------------------------------------------------------- |
|   License: Distributed under the Lesser General Public License (LGPL)     |
|            http://www.gnu.org/copyleft/lesser.html                        |
| This program is distributed in the hope that it will be useful - WITHOUT  |
| ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or     |
| FITNESS FOR A PARTICULAR PURPOSE.                                         |
'---------------------------------------------------------------------------'
-->
<head>
	<title>Upload Pattern - Malware Scanner</title>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
	<style type="text/css">
	*{
		margin:0;
		padding:0;
		}
	*:focus{
		outline:0;
		}
	body{
		background:rgb(221, 221, 221);
		color:#1B1B1B;
		margin-left:auto;
		margin-right:auto;
		font-family:Verdana;
		text-align:center;
		}
	#leftContent{
		float:left;
		padding: 6px;
		}
	#rightContent{
		float:right;
		padding: 25px 10px;
		}
	#rightContent h1{
		font-size:1.7em;
		font-family:Georgia;
		}
	#clear{
		clear:both;
		}
	#result textarea{
		width:60%;
		height:300px;
		border:0;
		padding:10px;
		font-family:Verdana;
		font-size:17px;
		color:#8A8A8A;
		margin-top:10px;
		}
	#pattern_form{
		text-align:center;
		margin-left:auto;
		margin-right:auto;
		width:60%;
		border:1px solid #6F5B64;
		padding:10px;
		}
	form{
		
		}
	input[type=submit]{
		float:right;
		background:#40B618;
		color:#1F1F1F;
		border:0;
		padding:7px;
		}
	label.pattern_label,input[type=file]{
		float:left;
		margin-right:10px;
		margin-top:5px;
		}
		#footer{
		margin-top: 16px;
		}
	#footer h4{
		font-family: sans-serif;
		font-size: 13px;
		color: rgb(92, 65, 65);
		}
	#footer h4 a{
		color:rgb(165, 47, 47);
		}
	#footer h4 a:hover{
		background:#D91125;
		color:#DADADA;
		text-decoration:none;
		}
	</style>
	<link rel="stylesheet" href="http://www.position-relative.net/creation/formValidator/css/validationEngine.jquery.css" type="text/css"/>
	<script src="http://www.position-relative.net/creation/formValidator/js/jquery-1.6.min.js" type="text/javascript"></script>
	<script src="http://www.position-relative.net/creation/formValidator/js/languages/jquery.validationEngine-en.js" type="text/javascript" charset="utf-8"></script>
	<script src="http://www.position-relative.net/creation/formValidator/js/jquery.validationEngine.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
	$(document).ready(function(){
		$("#upload_patternForm").validationEngine();
	});
	</script>
</head>

<body>
	<div id="main">
	<div id="leftContent">
	<a href="http://reventions.com"><img border="0" src="http://www.reventions.com/images/logo.png" /></a>
	</div>
	<div id="rightContent">
	<h1>Malware Scanner</h1>
	</div>
	</div>
	<div id="clear"></div>
	<div id="pattern_form">
	<form method="post" action="" enctype="multipart/form-data" id="upload_patternForm">
	<label class="pattern_label" for="pattern">Pattern</label>
	<input type="file" name="pattern" id="pattern" class="validate[required]" />
	<input type="submit" value="Upload" name="upload_pattern" />
	</form>
	<div id="clear"></div>
	</div>
	
	<br />
	<div id="result">
	<label>Pattern Example</label><br />
	<textarea readonly class="statusReport">Malware Code<--V-->Malware Code<--V-->Malware Code</textarea>
	</div>
<div id="footer">
<h4>Application made in Egypt by: <a title="visit my page on about.me" href="http://about.me/vmahmoud" target="_blank">Mahmoud Elgohary</a></h4>
</div>
</body>

</html>
<?php }?>
